round(max(zip_dists))
#test out the components-only ABM (and get runtime)
start <- Sys.time()
components_only <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = FALSE)
knitr::include_graphics("https://images.unsplash.com/photo-1590249351139-c6effec78d2a?ixid=MnwxMjA3fDB8MHxzZWFyY2h8MjV8fGJhYnklMjBjb3dzfGVufDB8fDB8fA%3D%3D&ixlib=rb-1.2.1&w=1000&q=80")
#read in brand data
brands <- read.csv("brand_data.csv")[, -1]
#remove brands with length of 12 (incorrectly specified according to manual inspection)
brands <- brands[-which(nchar(brands$brand) == 12), ]
#substring brand codes into vector of four components and one location
brands$brand <- lapply(1:nrow(brands), function(x){substring(brands$brand[[x]], first = c(1, 4, 7, 10, 13), last = c(3, 6, 9, 12, 13))})
#print a sample
brands[1:10, ]
load("raw_brands.RData")
#construct empty table for frequencies of letters in brands
brand_freq <- data.frame(letter = LETTERS, count = rep(0, length(letters)))
#for each brand
for(i in 1:nrow(brands)){
#get components that match letters (only first two characters since angles haven't been extracted yet)
matches <- which(substr(brands$brand[[i]], 1, 2) %in% paste0(LETTERS, ","))
#if there are matches
if(length(matches) > 0){
#store frequency table of them temporarily
temp <- table(substr(brands$brand[[i]], 1, 2)[matches])
#add those frequencies to the existing counts
brand_freq$count[match(names(temp), paste0(LETTERS, ","))] <- brand_freq$count[match(names(temp), paste0(LETTERS, ","))]+as.numeric(temp)
rm(temp)
}
rm(matches)
}
#plot brand data
ggplot2::ggplot(data = brand_freq, ggplot2::aes(x = letter, y = count)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Brands")
rm(brand_freq)
#load in all surnames that appeared more than 100 times in the 2010 US Census
census_names <- read.csv("Names_2010Census.csv")
#replace "(S)" in the census table with 0
breakdown_matrix <- as.matrix(census_names[, 6:11])
breakdown_matrix[which(breakdown_matrix == "(S)")] <- 0
census_names[, 6:11] <- breakdown_matrix
#replace census table with adjusted counts by race
census_names <- data.frame(letter = substr(census_names$name, 1, 1),
num_white = census_names$count*as.numeric(census_names$pctwhite),
num_black = census_names$count*as.numeric(census_names$pctblack),
num_api = census_names$count*as.numeric(census_names$pctapi),
num_na = census_names$count*as.numeric(census_names$pctaian),
num_mult = census_names$count*as.numeric(census_names$pct2prace),
num_hisp = census_names$count*as.numeric(census_names$pcthispanic))
#aggregate by letter
census_names <- aggregate(. ~ letter, data = census_names, sum)
#load in target racial breakdown for KS, which does not add up to 100% because of overlap (white, black, asian + pacific islander, native american, 2+, hispanic): https://www.census.gov/quickfacts/KS
ks_breakdown <- 2913314*c(0.863, 0.061, 0.033, 0.012, 0.031, 0.122)
#construct data frame for plotting
letter_data <- data.frame(letter = LETTERS,
name_freq = sapply(1:nrow(census_names), function(x){sum(census_names[x, 2:7])}),
adj_name_freq = sapply(1:nrow(census_names), function(x){sum(ks_breakdown/census_names[x, 2:7])}))
#plot name data
ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = name_freq)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Surnames")
#plot adjusted name data
#ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = adj_name_freq)) +
#  ggplot2::geom_bar(stat = "identity") +
#  ggplot2::theme_linedraw() +
#  ggplot2::labs(x = "Letter", y = "Adjusted Frequency", title = "Surnames")
rm(list = c("census_names", "breakdown_matrix", "ks_breakdown", "letter_data"))
#load in the checked brands with letters and get the proportion correct
prop_correct <- mean(read.csv("letters_checked.csv")$initials)*100
#load in adjustments from components.xlsx
collapse <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "collapse"))
rotation <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "rotation"))
#reformat rotation
rotation$rot <- strsplit(rotation$rot, ", ")
#store components with commas
components <- stringr::str_pad(rotation$component, width = 3, side = "right", pad = ",")
#print them
components
load("location_data/all_zips.RData")
load("location_data/zip_dists.RData")
load("converted_brands.RData")
brands[1:10,]
#get zip codes within 200 km and 100 km of target location
copy_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 200))
dist_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 100))
kansas_map <- ggplot2::map_data("state", "kansas")
map_example <- data.frame(zip = all_zips$zip, lon = all_zips$lon, lat = all_zips$lat,
color = rep(0, length(all_zips$zip)),
shape = rep(0, length(all_zips$zip)))
map_example$color[which(map_example$zip %in% copy_example)] <- 1
map_example$color[which(map_example$zip %in% dist_example)] <- 2
map_example$color[which(map_example$zip == 67427)] <- 3
map_example$shape[which(map_example$zip == 67427)] <- 1
map_example$color <- as.factor(map_example$color)
map_example$shape <- as.factor(map_example$shape)
ggplot2::ggplot(kansas_map, ggplot2::aes(x = long, y = lat)) +
ggplot2::geom_point(map_example, mapping = ggplot2::aes(x = lon, y = lat, colour = color, shape = shape, size = shape)) +
ggplot2::geom_polygon(fill = "transparent", colour = "black") +
ggplot2::scale_colour_manual(values = c("grey90", scales::hue_pal()(3)[3], scales::hue_pal()(3)[1], scales::hue_pal()(3)[2])) +
ggplot2::scale_shape_manual(values = c(16, 17)) +
ggplot2::scale_size_manual(values = c(2, 8)) +
ggplot2::coord_quickmap() +
ggplot2::theme_minimal() +
ggplot2::labs(x = "Longitude", y = "Latitude") +
ggplot2::theme(legend.position = "none")
#remove objects
rm(list = c("copy_example", "dist_example", "kansas_map", "map_example"))
#create data frame for poisson example
pois_example <- data.frame(n_comps = c(1, 2, 3, 4),
probs = c(BBmisc::normalize(dpois(c(1, 2, 3, 4), 0.5), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 3), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 15), "range")),
lambda = c(rep(0.5, 4), rep(3, 4), rep(15, 4)))
#plot poisson example
ggplot2::ggplot(data = pois_example, ggplot2::aes(x = n_comps, y = probs, group = as.factor(lambda))) +
ggplot2::geom_line(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::geom_point(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::labs(x = "Number of Components", y = "Normalized Probabilities", color = "\u03bb") +
ggplot2::theme_linedraw()
#remove object
rm(pois_example)
source("cattlebrandABM.R")
#probability of rotation (proportion of rotated brands in the full dataset)
rot_prob <- as.numeric(1-(table(brands[, 5:8])[1]/sum(table(brands[, 5:8]))))
#separate brands data by year
brands_2008 <- data.table::data.table(brands[which(brands[, 10] == 2008), 1:9])
brands_2014 <- data.table::data.table(brands[which(brands[, 10] == 2014), 1:9])
brands_2015 <- data.table::data.table(brands[which(brands[, 10] == 2015), 1:9])
brands_2016 <- data.table::data.table(brands[which(brands[, 10] == 2016), 1:9])
#calculate average number of new brands that appear each year and old brands that disappear each year (fsetdiff gets rows of first that are not in second)
n_new <- mean(c((nrow(data.table::fsetdiff(brands_2014, brands_2008))/6),
nrow(data.table::fsetdiff(brands_2015, brands_2014)),
nrow(data.table::fsetdiff(brands_2016, brands_2015))))
n_old <- mean(c((nrow(data.table::fsetdiff(brands_2008, brands_2014))/6),
nrow(data.table::fsetdiff(brands_2014, brands_2015)),
nrow(data.table::fsetdiff(brands_2015, brands_2016))))
#reshape components
components <- data.table::data.table(components = components, rotatable = rotation$rot)
components$rotatable[which(components$rotatable == "NA")] <- NA
components$rotatable <- sapply(1:nrow(components), function(x){as.numeric(components$rotatable[[x]])})
#get min and max distances between zip codes (to inform prior range)
round(min(zip_dists[which(zip_dists != 0)]))
round(max(zip_dists))
#test out the components-only ABM (and get runtime)
start <- Sys.time()
components_only <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = FALSE)
Sys.time() - start
#print output
components_only
#test out the components and angles ABM (and get runtime)
start <- Sys.time()
components_angles <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = TRUE)
Sys.time() - start
#print output
components_angles
#test out the components and angles ABM with mean edit distance included in the summary statistics (and get runtime)
start <- Sys.time()
components_angles_edits <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = TRUE, edit_dist_prop = 0.1)
Sys.time() - start
#print output
components_angles_edits
brands_2008
running_brands <- brands_2008
edit_dist_mat <- adist(sapply(sample(nrow(running_brands), nrow(running_brands)*edit_dist_prop, replace = FALSE), function(x){intToUtf8(as.numeric(paste0(running_brands[x, 1:4], running_brands[x, 5:8])))}))
edit_dist_prop <- 1
edit_dist_mat <- adist(sapply(sample(nrow(running_brands), nrow(running_brands)*edit_dist_prop, replace = FALSE), function(x){intToUtf8(as.numeric(paste0(running_brands[x, 1:4], running_brands[x, 5:8])))}))
edit_dists <- edit_dist_mat[upper.tri(edit_dist_mat)]
edit_dists
hist(edit_dists)
hist(edit_dists)
source("cattlebrandABM.R")
start <- Sys.time()
components_angles_edits <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = TRUE, edit_dist_prop = 0.1)
components_only <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = FALSE)
i
t_steps
max(sampling_years) - init_year
knitr::include_graphics("https://images.unsplash.com/photo-1590249351139-c6effec78d2a?ixid=MnwxMjA3fDB8MHxzZWFyY2h8MjV8fGJhYnklMjBjb3dzfGVufDB8fDB8fA%3D%3D&ixlib=rb-1.2.1&w=1000&q=80")
#read in brand data
brands <- read.csv("brand_data.csv")[, -1]
#remove brands with length of 12 (incorrectly specified according to manual inspection)
brands <- brands[-which(nchar(brands$brand) == 12), ]
#substring brand codes into vector of four components and one location
brands$brand <- lapply(1:nrow(brands), function(x){substring(brands$brand[[x]], first = c(1, 4, 7, 10, 13), last = c(3, 6, 9, 12, 13))})
#print a sample
brands[1:10, ]
load("raw_brands.RData")
#construct empty table for frequencies of letters in brands
brand_freq <- data.frame(letter = LETTERS, count = rep(0, length(letters)))
#for each brand
for(i in 1:nrow(brands)){
#get components that match letters (only first two characters since angles haven't been extracted yet)
matches <- which(substr(brands$brand[[i]], 1, 2) %in% paste0(LETTERS, ","))
#if there are matches
if(length(matches) > 0){
#store frequency table of them temporarily
temp <- table(substr(brands$brand[[i]], 1, 2)[matches])
#add those frequencies to the existing counts
brand_freq$count[match(names(temp), paste0(LETTERS, ","))] <- brand_freq$count[match(names(temp), paste0(LETTERS, ","))]+as.numeric(temp)
rm(temp)
}
rm(matches)
}
#plot brand data
ggplot2::ggplot(data = brand_freq, ggplot2::aes(x = letter, y = count)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Brands")
rm(brand_freq)
#load in all surnames that appeared more than 100 times in the 2010 US Census
census_names <- read.csv("Names_2010Census.csv")
#replace "(S)" in the census table with 0
breakdown_matrix <- as.matrix(census_names[, 6:11])
breakdown_matrix[which(breakdown_matrix == "(S)")] <- 0
census_names[, 6:11] <- breakdown_matrix
#replace census table with adjusted counts by race
census_names <- data.frame(letter = substr(census_names$name, 1, 1),
num_white = census_names$count*as.numeric(census_names$pctwhite),
num_black = census_names$count*as.numeric(census_names$pctblack),
num_api = census_names$count*as.numeric(census_names$pctapi),
num_na = census_names$count*as.numeric(census_names$pctaian),
num_mult = census_names$count*as.numeric(census_names$pct2prace),
num_hisp = census_names$count*as.numeric(census_names$pcthispanic))
#aggregate by letter
census_names <- aggregate(. ~ letter, data = census_names, sum)
#load in target racial breakdown for KS, which does not add up to 100% because of overlap (white, black, asian + pacific islander, native american, 2+, hispanic): https://www.census.gov/quickfacts/KS
ks_breakdown <- 2913314*c(0.863, 0.061, 0.033, 0.012, 0.031, 0.122)
#construct data frame for plotting
letter_data <- data.frame(letter = LETTERS,
name_freq = sapply(1:nrow(census_names), function(x){sum(census_names[x, 2:7])}),
adj_name_freq = sapply(1:nrow(census_names), function(x){sum(ks_breakdown/census_names[x, 2:7])}))
#plot name data
ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = name_freq)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Surnames")
#plot adjusted name data
#ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = adj_name_freq)) +
#  ggplot2::geom_bar(stat = "identity") +
#  ggplot2::theme_linedraw() +
#  ggplot2::labs(x = "Letter", y = "Adjusted Frequency", title = "Surnames")
rm(list = c("census_names", "breakdown_matrix", "ks_breakdown", "letter_data"))
#load in the checked brands with letters and get the proportion correct
prop_correct <- mean(read.csv("letters_checked.csv")$initials)*100
#load in adjustments from components.xlsx
collapse <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "collapse"))
rotation <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "rotation"))
#reformat rotation
rotation$rot <- strsplit(rotation$rot, ", ")
#store components with commas
components <- stringr::str_pad(rotation$component, width = 3, side = "right", pad = ",")
#print them
components
load("location_data/all_zips.RData")
load("location_data/zip_dists.RData")
load("converted_brands.RData")
brands[1:10,]
#get zip codes within 200 km and 100 km of target location
copy_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 200))
dist_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 100))
kansas_map <- ggplot2::map_data("state", "kansas")
map_example <- data.frame(zip = all_zips$zip, lon = all_zips$lon, lat = all_zips$lat,
color = rep(0, length(all_zips$zip)),
shape = rep(0, length(all_zips$zip)))
map_example$color[which(map_example$zip %in% copy_example)] <- 1
map_example$color[which(map_example$zip %in% dist_example)] <- 2
map_example$color[which(map_example$zip == 67427)] <- 3
map_example$shape[which(map_example$zip == 67427)] <- 1
map_example$color <- as.factor(map_example$color)
map_example$shape <- as.factor(map_example$shape)
ggplot2::ggplot(kansas_map, ggplot2::aes(x = long, y = lat)) +
ggplot2::geom_point(map_example, mapping = ggplot2::aes(x = lon, y = lat, colour = color, shape = shape, size = shape)) +
ggplot2::geom_polygon(fill = "transparent", colour = "black") +
ggplot2::scale_colour_manual(values = c("grey90", scales::hue_pal()(3)[3], scales::hue_pal()(3)[1], scales::hue_pal()(3)[2])) +
ggplot2::scale_shape_manual(values = c(16, 17)) +
ggplot2::scale_size_manual(values = c(2, 8)) +
ggplot2::coord_quickmap() +
ggplot2::theme_minimal() +
ggplot2::labs(x = "Longitude", y = "Latitude") +
ggplot2::theme(legend.position = "none")
#remove objects
rm(list = c("copy_example", "dist_example", "kansas_map", "map_example"))
#create data frame for poisson example
pois_example <- data.frame(n_comps = c(1, 2, 3, 4),
probs = c(BBmisc::normalize(dpois(c(1, 2, 3, 4), 0.5), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 3), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 15), "range")),
lambda = c(rep(0.5, 4), rep(3, 4), rep(15, 4)))
#plot poisson example
ggplot2::ggplot(data = pois_example, ggplot2::aes(x = n_comps, y = probs, group = as.factor(lambda))) +
ggplot2::geom_line(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::geom_point(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::labs(x = "Number of Components", y = "Normalized Probabilities", color = "\u03bb") +
ggplot2::theme_linedraw()
#remove object
rm(pois_example)
source("cattlebrandABM.R")
#probability of rotation (proportion of rotated brands in the full dataset)
rot_prob <- as.numeric(1-(table(brands[, 5:8])[1]/sum(table(brands[, 5:8]))))
#separate brands data by year
brands_2008 <- data.table::data.table(brands[which(brands[, 10] == 2008), 1:9])
brands_2014 <- data.table::data.table(brands[which(brands[, 10] == 2014), 1:9])
brands_2015 <- data.table::data.table(brands[which(brands[, 10] == 2015), 1:9])
brands_2016 <- data.table::data.table(brands[which(brands[, 10] == 2016), 1:9])
#calculate average number of new brands that appear each year and old brands that disappear each year (fsetdiff gets rows of first that are not in second)
n_new <- mean(c((nrow(data.table::fsetdiff(brands_2014, brands_2008))/6),
nrow(data.table::fsetdiff(brands_2015, brands_2014)),
nrow(data.table::fsetdiff(brands_2016, brands_2015))))
n_old <- mean(c((nrow(data.table::fsetdiff(brands_2008, brands_2014))/6),
nrow(data.table::fsetdiff(brands_2014, brands_2015)),
nrow(data.table::fsetdiff(brands_2015, brands_2016))))
#reshape components
components <- data.table::data.table(components = components, rotatable = rotation$rot)
components$rotatable[which(components$rotatable == "NA")] <- NA
components$rotatable <- sapply(1:nrow(components), function(x){as.numeric(components$rotatable[[x]])})
#get min and max distances between zip codes (to inform prior range)
round(min(zip_dists[which(zip_dists != 0)]))
round(max(zip_dists))
#test out the components-only ABM (and get runtime)
start <- Sys.time()
components_only <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = FALSE)
knitr::include_graphics("https://images.unsplash.com/photo-1590249351139-c6effec78d2a?ixid=MnwxMjA3fDB8MHxzZWFyY2h8MjV8fGJhYnklMjBjb3dzfGVufDB8fDB8fA%3D%3D&ixlib=rb-1.2.1&w=1000&q=80")
#read in brand data
brands <- read.csv("brand_data.csv")[, -1]
#remove brands with length of 12 (incorrectly specified according to manual inspection)
brands <- brands[-which(nchar(brands$brand) == 12), ]
#substring brand codes into vector of four components and one location
brands$brand <- lapply(1:nrow(brands), function(x){substring(brands$brand[[x]], first = c(1, 4, 7, 10, 13), last = c(3, 6, 9, 12, 13))})
#print a sample
brands[1:10, ]
load("raw_brands.RData")
#construct empty table for frequencies of letters in brands
brand_freq <- data.frame(letter = LETTERS, count = rep(0, length(letters)))
#for each brand
for(i in 1:nrow(brands)){
#get components that match letters (only first two characters since angles haven't been extracted yet)
matches <- which(substr(brands$brand[[i]], 1, 2) %in% paste0(LETTERS, ","))
#if there are matches
if(length(matches) > 0){
#store frequency table of them temporarily
temp <- table(substr(brands$brand[[i]], 1, 2)[matches])
#add those frequencies to the existing counts
brand_freq$count[match(names(temp), paste0(LETTERS, ","))] <- brand_freq$count[match(names(temp), paste0(LETTERS, ","))]+as.numeric(temp)
rm(temp)
}
rm(matches)
}
#plot brand data
ggplot2::ggplot(data = brand_freq, ggplot2::aes(x = letter, y = count)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Brands")
rm(brand_freq)
#load in all surnames that appeared more than 100 times in the 2010 US Census
census_names <- read.csv("Names_2010Census.csv")
#replace "(S)" in the census table with 0
breakdown_matrix <- as.matrix(census_names[, 6:11])
breakdown_matrix[which(breakdown_matrix == "(S)")] <- 0
census_names[, 6:11] <- breakdown_matrix
#replace census table with adjusted counts by race
census_names <- data.frame(letter = substr(census_names$name, 1, 1),
num_white = census_names$count*as.numeric(census_names$pctwhite),
num_black = census_names$count*as.numeric(census_names$pctblack),
num_api = census_names$count*as.numeric(census_names$pctapi),
num_na = census_names$count*as.numeric(census_names$pctaian),
num_mult = census_names$count*as.numeric(census_names$pct2prace),
num_hisp = census_names$count*as.numeric(census_names$pcthispanic))
#aggregate by letter
census_names <- aggregate(. ~ letter, data = census_names, sum)
#load in target racial breakdown for KS, which does not add up to 100% because of overlap (white, black, asian + pacific islander, native american, 2+, hispanic): https://www.census.gov/quickfacts/KS
ks_breakdown <- 2913314*c(0.863, 0.061, 0.033, 0.012, 0.031, 0.122)
#construct data frame for plotting
letter_data <- data.frame(letter = LETTERS,
name_freq = sapply(1:nrow(census_names), function(x){sum(census_names[x, 2:7])}),
adj_name_freq = sapply(1:nrow(census_names), function(x){sum(ks_breakdown/census_names[x, 2:7])}))
#plot name data
ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = name_freq)) +
ggplot2::geom_bar(stat = "identity") +
ggplot2::theme_linedraw() +
ggplot2::labs(x = "Letter", y = "Frequency", title = "Surnames")
#plot adjusted name data
#ggplot2::ggplot(data = letter_data, ggplot2::aes(x = letter, y = adj_name_freq)) +
#  ggplot2::geom_bar(stat = "identity") +
#  ggplot2::theme_linedraw() +
#  ggplot2::labs(x = "Letter", y = "Adjusted Frequency", title = "Surnames")
rm(list = c("census_names", "breakdown_matrix", "ks_breakdown", "letter_data"))
#load in the checked brands with letters and get the proportion correct
prop_correct <- mean(read.csv("letters_checked.csv")$initials)*100
#load in adjustments from components.xlsx
collapse <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "collapse"))
rotation <- data.table::as.data.table(readxl::read_excel(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/", "components.xlsx"), sheet = "rotation"))
#reformat rotation
rotation$rot <- strsplit(rotation$rot, ", ")
#store components with commas
components <- stringr::str_pad(rotation$component, width = 3, side = "right", pad = ",")
#print them
components
load("location_data/all_zips.RData")
load("location_data/zip_dists.RData")
load("converted_brands.RData")
brands[1:10,]
#get zip codes within 200 km and 100 km of target location
copy_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 200))
dist_example <- names(which(zip_dists[, which(colnames(zip_dists) == 67427)] <= 100))
kansas_map <- ggplot2::map_data("state", "kansas")
map_example <- data.frame(zip = all_zips$zip, lon = all_zips$lon, lat = all_zips$lat,
color = rep(0, length(all_zips$zip)),
shape = rep(0, length(all_zips$zip)))
map_example$color[which(map_example$zip %in% copy_example)] <- 1
map_example$color[which(map_example$zip %in% dist_example)] <- 2
map_example$color[which(map_example$zip == 67427)] <- 3
map_example$shape[which(map_example$zip == 67427)] <- 1
map_example$color <- as.factor(map_example$color)
map_example$shape <- as.factor(map_example$shape)
ggplot2::ggplot(kansas_map, ggplot2::aes(x = long, y = lat)) +
ggplot2::geom_point(map_example, mapping = ggplot2::aes(x = lon, y = lat, colour = color, shape = shape, size = shape)) +
ggplot2::geom_polygon(fill = "transparent", colour = "black") +
ggplot2::scale_colour_manual(values = c("grey90", scales::hue_pal()(3)[3], scales::hue_pal()(3)[1], scales::hue_pal()(3)[2])) +
ggplot2::scale_shape_manual(values = c(16, 17)) +
ggplot2::scale_size_manual(values = c(2, 8)) +
ggplot2::coord_quickmap() +
ggplot2::theme_minimal() +
ggplot2::labs(x = "Longitude", y = "Latitude") +
ggplot2::theme(legend.position = "none")
#remove objects
rm(list = c("copy_example", "dist_example", "kansas_map", "map_example"))
#create data frame for poisson example
pois_example <- data.frame(n_comps = c(1, 2, 3, 4),
probs = c(BBmisc::normalize(dpois(c(1, 2, 3, 4), 0.5), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 3), "range"),
BBmisc::normalize(dpois(c(1, 2, 3, 4), 15), "range")),
lambda = c(rep(0.5, 4), rep(3, 4), rep(15, 4)))
#plot poisson example
ggplot2::ggplot(data = pois_example, ggplot2::aes(x = n_comps, y = probs, group = as.factor(lambda))) +
ggplot2::geom_line(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::geom_point(ggplot2::aes(color = as.factor(lambda))) +
ggplot2::labs(x = "Number of Components", y = "Normalized Probabilities", color = "\u03bb") +
ggplot2::theme_linedraw()
#remove object
rm(pois_example)
source("cattlebrandABM.R")
#probability of rotation (proportion of rotated brands in the full dataset)
rot_prob <- as.numeric(1-(table(brands[, 5:8])[1]/sum(table(brands[, 5:8]))))
#separate brands data by year
brands_2008 <- data.table::data.table(brands[which(brands[, 10] == 2008), 1:9])
brands_2014 <- data.table::data.table(brands[which(brands[, 10] == 2014), 1:9])
brands_2015 <- data.table::data.table(brands[which(brands[, 10] == 2015), 1:9])
brands_2016 <- data.table::data.table(brands[which(brands[, 10] == 2016), 1:9])
#calculate average number of new brands that appear each year and old brands that disappear each year (fsetdiff gets rows of first that are not in second)
n_new <- mean(c((nrow(data.table::fsetdiff(brands_2014, brands_2008))/6),
nrow(data.table::fsetdiff(brands_2015, brands_2014)),
nrow(data.table::fsetdiff(brands_2016, brands_2015))))
n_old <- mean(c((nrow(data.table::fsetdiff(brands_2008, brands_2014))/6),
nrow(data.table::fsetdiff(brands_2014, brands_2015)),
nrow(data.table::fsetdiff(brands_2015, brands_2016))))
#reshape components
components <- data.table::data.table(components = components, rotatable = rotation$rot)
components$rotatable[which(components$rotatable == "NA")] <- NA
components$rotatable <- sapply(1:nrow(components), function(x){as.numeric(components$rotatable[[x]])})
#get min and max distances between zip codes (to inform prior range)
round(min(zip_dists[which(zip_dists != 0)]))
round(max(zip_dists))
#test out the components-only ABM (and get runtime)
start <- Sys.time()
components_only <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = FALSE)
Sys.time() - start
#print output
components_only
#test out the components and angles ABM (and get runtime)
start <- Sys.time()
components_angles <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = TRUE)
Sys.time() - start
#print output
components_angles
#test out the components and angles ABM with mean edit distance included in the summary statistics (and get runtime)
start <- Sys.time()
components_angles_edits <- cattlebrandABM(init_brands = as.matrix(brands_2008), components, all_zips, zip_dists,
init_year = 2008, sampling_years = c(2014, 2015, 2016), n_new, n_old,
rot_prob, complexity = 3, copy_radius = 200, copy_strength = 1,
dist_radius = 100, dist_strength = 1, angles = TRUE, edit_dist_prop = 0.1)
Sys.time() - start
#print output
components_angles_edits
